<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="TaoHongqiang">
    
    <title>
        
            SpringAOP入门 |
        
        敢&#39;笔记
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.png","favicon":"/images/logo.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"你努力的样子藏着你父母幸福的晚年"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                敢&#39;笔记
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">SpringAOP入门</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">TaoHongqiang</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-04-18 13:36:06</span>
        <span class="mobile">2022-04-18 13:36</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%A1%86%E6%9E%B6/">框架</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>10.8k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>46 分钟</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="1-动态代理"><a href="#1-动态代理" class="headerlink" title="1.  动态代理"></a>1.  动态代理</h1><p><strong>方法增强: 在不惊动原始设计的基础上(不修改源代码)，为其添加功能</strong></p>
<p>要实现对一个类的方法增强,我们有以下三种方式: 继承,静态代理(装饰模式)和动态代理</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1. 继承 </span></span><br><span class="line"><span class="code">	1). 实现方式</span></span><br><span class="line"><span class="code">			创建一个子类继承需要增强的类,重写该方法进行增强</span></span><br><span class="line"><span class="code">	2). 优缺点</span></span><br><span class="line"><span class="code">		a. 优点: 实现简单</span></span><br><span class="line"><span class="code">		b. 缺点: 对比其他两种方式, 继承中的一个子类只能增强其父类(只能增强一个)</span></span><br><span class="line"><span class="code">			class A extends B, 那么A只能增强B</span></span><br><span class="line"><span class="code"># 2. 装饰者模式(静态代理):</span></span><br><span class="line"><span class="code">	1). 实现方式</span></span><br><span class="line"><span class="code">		a. 装饰者类和被装饰者类必须实现同一个接口或继承同一个类</span></span><br><span class="line"><span class="code">        b. 在装饰者类中必须要有被装饰者类的引用</span></span><br><span class="line"><span class="code">        c. 在装饰者类中对需要增强的方法进行增强</span></span><br><span class="line"><span class="code">        d. 在装饰者类中对不需要增强的方法调用原来的逻辑</span></span><br><span class="line"><span class="code">    2). 优缺点</span></span><br><span class="line"><span class="code">    	a. 优点: 对比继承方式中的子类,装饰模式的代理类可以增强父接口/父类的所有子类</span></span><br><span class="line"><span class="code">        b. 缺点: 对比动态代理,装饰模式的代理类需要提前定义</span></span><br><span class="line"><span class="code">        class A implements B&#123;</span></span><br><span class="line"><span class="code">        	B fd;</span></span><br><span class="line"><span class="code">        	public A(B fd)&#123;</span></span><br><span class="line"><span class="code">        		this.fd = fd;</span></span><br><span class="line"><span class="code">        	&#125;</span></span><br><span class="line"><span class="code">        	...</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        A可以增强B所有的子类</span></span><br><span class="line"><span class="code"># 3. 动态代理:</span></span><br><span class="line"><span class="code">	1). 实现方式</span></span><br><span class="line"><span class="code">		a. JDK的动态代理:</span></span><br><span class="line"><span class="code">			Proxy: 基于接口的代理(Proxy来源于JDK)</span></span><br><span class="line"><span class="code">		b. cglib的动态代理	</span></span><br><span class="line"><span class="code">            Enhancer: 基于类的代理(第三方工具包)</span></span><br><span class="line"><span class="code">    2). 优缺点:</span></span><br><span class="line"><span class="code">    	a. 优点: 无论是JDK还是cglib的动态代理, 采用的都是动态字节码技术,也就是代理类都是运行过程中动态产生的,无需在编写代码时定义</span></span><br><span class="line"><span class="code">    	b. 缺点:与继承或静态代理对比, 相对不好理解</span></span><br><span class="line"><span class="code"># 4. JDK的动态代理与cglib详解</span></span><br><span class="line"><span class="code">1). 使用条件</span></span><br><span class="line"><span class="code">    a. JDK动态代理只能对实现了接口的类生成代理，而不能针对类</span></span><br><span class="line"><span class="code">    b. CGLib是针对类实现代理，主要是对指定的类生成一个子类，重写其中的方法</span></span><br><span class="line"><span class="code">    	（就是继承,父类的方法不能用final和private修饰)</span></span><br><span class="line"><span class="code">2). 性能对比</span></span><br><span class="line"><span class="code">    a. 在JDK1.6、JDK1.7、JDK1.8逐步对JDK动态代理优化之后，在调用次数较少的情况下，JDK代理效率高于CGLib代理效率，只有当进行大量调用的时候，JDK1.6和JDK1.7比CGLib代理效率低一点</span></span><br><span class="line"><span class="code">    b. 但是到JDK1.8的时候，JDK代理效率高于CGLib代理</span></span><br><span class="line"><span class="code">3). spring的AOP采用的代理方案</span></span><br><span class="line"><span class="code">    a. 当Bean实现接口时，Spring就会用JDK的动态代理</span></span><br><span class="line"><span class="code">    b. 当Bean没有实现接口时，Spring使用CGLib来实现</span></span><br><span class="line"><span class="code">    c. 备注: 开发者可以在spring中强制使用CGLib (没人会这么干)</span></span><br><span class="line"><span class="code">    （在Spring配置中加入&lt;aop:aspectj-autoproxy proxy-target-class=“true”/&gt;）</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p> 备注:</p>
<ol>
<li><p>我们今天重点回顾jdk动态代理和讲解cglib动态代理</p>
</li>
<li><p>至于继承和静态代理的详细介绍,请回顾javase- day13的内容</p>
</li>
</ol>
</blockquote>
<h2 id="1-1-动态代理——JDK-Proxy"><a href="#1-1-动态代理——JDK-Proxy" class="headerlink" title="1.1) 动态代理——JDK Proxy"></a>1.1) 动态代理——JDK Proxy</h2><p><strong>JDK Proxy动态代理是针对对象做代理，要求原始对象具有接口实现，并对接口方法进行增强.</strong></p>
<p><strong>需求</strong>: 在service层的类AccountServiceImpl(有父接口)有4个方法,需求是在不修改源码的基础上, 对每个方法进行增强</p>
<p>​        在方法执行前打印: 11111111111111111<br>​       在方法执行后打印: 22222222222222222</p>
<p><strong>代码演示</strong></p>
<p>导入素材中的day03-demo01-proxy</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1610090724046.png"
                      alt="1610090724046"
                > </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">//有返回值</span></span><br><span class="line">    String <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//有参数</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;findAll.............&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;result: 查询结果&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;insert.............&quot;</span> + str);</span><br><span class="line">      <span class="comment">/*  try &#123;</span></span><br><span class="line"><span class="comment">            int i = 1/0;</span></span><br><span class="line"><span class="comment">        &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">            throw new RuntimeException();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;delete.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.impl.AccountServiceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    代理模式</span></span><br><span class="line"><span class="comment">    1. 创建被代理类对象</span></span><br><span class="line"><span class="comment">    2. 创建代理类对象</span></span><br><span class="line"><span class="comment">         增强了被代理类对象的功能</span></span><br><span class="line"><span class="comment">    3. 调用代理类对象的方法</span></span><br><span class="line"><span class="comment">        底层往往调用了被代理类对象的方法</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   JDK Proxy:</span></span><br><span class="line"><span class="comment">        代理类和被代理类拥有相同的父接口!</span></span><br><span class="line"><span class="comment">        代理类必须基于接口的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdkProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 创建被代理类对象</span></span><br><span class="line">        <span class="type">AccountServiceImpl</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 创建代理类对象</span></span><br><span class="line"><span class="comment">//        ClassLoader loader = service.getClass().getClassLoader();</span></span><br><span class="line"><span class="comment">//        Class&lt;?&gt;[] interfaces = service.getClass().getInterfaces();</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> JdkProxy.class.getClassLoader(); <span class="comment">// 应用类加载器: 加载第三方类 (类加载器)</span></span><br><span class="line">        Class&lt;?&gt;[] interfaces = &#123;AccountService.class&#125;;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                invoke方法 : 代理类对象调用任意方法,都会执行此方法</span></span><br><span class="line"><span class="comment">                   1). proxy : 代理类对象 (没用)</span></span><br><span class="line"><span class="comment">                   2). method : 代理类对象当前调用的方法</span></span><br><span class="line"><span class="comment">                   3). args : 代理类对象当前调用方法传入的参数</span></span><br><span class="line"><span class="comment">                  return  : 代理类对象当前调用方法的返回值</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;11111111111111&quot;</span>);</span><br><span class="line">                    <span class="comment">//service.insert(&quot;一个用户&quot;);</span></span><br><span class="line">                    result = method.invoke(service, args);</span><br><span class="line">                    System.out.println(<span class="string">&quot;22222222222222&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;33333333333333&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;444444444444444&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">AccountService</span> <span class="variable">proxy</span> <span class="operator">=</span> (AccountService) Proxy.newProxyInstance(loader,interfaces,h);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 调用代理类对象的方法</span></span><br><span class="line">        proxy.insert(<span class="string">&quot;一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="1-2-动态代理——CGLIB"><a href="#1-2-动态代理——CGLIB" class="headerlink" title="1.2) 动态代理——CGLIB"></a>1.2) 动态代理——CGLIB</h2><ul>
<li>CGLIB(Code Generation Library)，Code生成类库 (第三方的库,不是JDK)</li>
<li>CGLIB动态代理不限定被代理类是否具有接口，可以对任意操作进行增强</li>
<li>CGLIB动态代理继承于被代理类，动态创建出新的代理对象</li>
</ul>
<p><strong>需求</strong></p>
<p>   在service层的类(没有父接口)有4个方法,现在需求在不修改源码的基础上, 对每个方法进行增强</p>
<p>​         在方法执行前打印: 11111111111111111<br>​                在方法执行后打印: 22222222222222222</p>
<p>​         在方法执行异常后打印: 33333333333333</p>
<p>​         在都执行完之后打印:4444444444444444</p>
<p><strong>代码演示</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            使用cglib需要导入cglib的jar包</span></span><br><span class="line"><span class="comment">            但cglib已经被Spring整合了,所以导入Spring-context包即可</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceClass</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;findAll.............&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;result: 查询结果&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;insert.............&quot;</span> + str);</span><br><span class="line">       <span class="comment">/* try &#123;</span></span><br><span class="line"><span class="comment">            int i = 1/0;</span></span><br><span class="line"><span class="comment">        &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">           //throw new RuntimeException(&quot;&quot;);</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;delete.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.cblib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountServiceClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.proxy.Callback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    CGLIB: 基于继承的动态代理,增强方法的原理基于方法重写</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    注意: 被final修饰的方法不能被重写</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnhancerDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 创建被代理类的对象</span></span><br><span class="line">        <span class="type">AccountServiceClass</span> <span class="variable">asc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccountServiceClass</span>();</span><br><span class="line">        <span class="comment">//2. 创建代理类对象</span></span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">AccountServiceClass</span>&gt; type = asc.getClass();</span><br><span class="line">        <span class="type">Callback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodInterceptor</span>() &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                intercept方法: 代理类对象执行任意方法,都会调用此方法</span></span><br><span class="line"><span class="comment">                1. proxy :表示代理类对象本身 (没什么用)</span></span><br><span class="line"><span class="comment">                2. method : 表示代理类对象当前调用的方法</span></span><br><span class="line"><span class="comment">                3. args : 表示代理类对象当前调用方法传入的参数</span></span><br><span class="line"><span class="comment">                4. methodProxy : 方法代理 (没什么用)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                返回值Object : 表示代理类对象当前调用方法产生的返回值</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;111111111111111&quot;</span>);</span><br><span class="line">                    result = method.invoke(asc, args);</span><br><span class="line">                    System.out.println(<span class="string">&quot;222222222222222&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;333333333333333&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;444444444444444&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">AccountServiceClass</span> <span class="variable">proxy</span> <span class="operator">=</span> (AccountServiceClass) Enhancer.create(type,callback);</span><br><span class="line">        <span class="comment">//3. 调用代理类对象的方法</span></span><br><span class="line">        proxy.insert(<span class="string">&quot;一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="2-Spring-AOP"><a href="#2-Spring-AOP" class="headerlink" title="2. Spring-AOP"></a>2. Spring-AOP</h1><h2 id="2-1-AOP概述"><a href="#2-1-AOP概述" class="headerlink" title="2.1) AOP概述"></a>2.1) AOP概述</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1. 介绍</span></span><br><span class="line"><span class="code">	AOP(Aspect Oriented Programing)面向切面编程，一种编程范式，指导开发者如何组织程序结构</span></span><br><span class="line"><span class="code">		OOP(Object Oriented Programing)面向对象编程</span></span><br><span class="line"><span class="code"># 2. 作用</span></span><br><span class="line"><span class="code">	在程序运行期间,不修改源码的基础上对已有方法进行增强</span></span><br><span class="line"><span class="code">    (无侵入性: 耦合度低)</span></span><br><span class="line"><span class="code"># 3. 优势</span></span><br><span class="line"><span class="code">	1). 减少重复代码</span></span><br><span class="line"><span class="code">	2). 提高开发效率</span></span><br><span class="line"><span class="code">	3). 维护方便</span></span><br><span class="line"><span class="code"># 4. spring的AOP的实现方式</span></span><br><span class="line"><span class="code">	1). 当Bean实现接口时，Spring就会用JDK的动态代理</span></span><br><span class="line"><span class="code">    2). 当Bean没有实现接口时，Spring使用CGLib来实现</span></span><br><span class="line"><span class="code">    	JDK8之后, JDK动态代理效率高于CGlib</span></span><br><span class="line"><span class="code">    3). 备注: 开发者可以在spring中强制使用CGLib (了解)</span></span><br><span class="line"><span class="code">    （在Spring配置中加入&lt;aop:aspectj-autoproxy proxy-target-class=“true”/&gt;）</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-AOP入门"><a href="#2-2-AOP入门" class="headerlink" title="2.2) AOP入门"></a>2.2) AOP入门</h2><h3 id="2-2-1-AOP相关概念"><a href="#2-2-1-AOP相关概念" class="headerlink" title="2.2.1) AOP相关概念"></a>2.2.1) AOP相关概念</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> Target(目标对象)</span><br><span class="line"><span class="code">		要被增强的对象(被代理类对象)</span></span><br><span class="line"><span class="code">2. Proxy（代理对象）</span></span><br><span class="line"><span class="code">		对目标对象的增强对象 (生成的代理类对象)	</span></span><br><span class="line"><span class="code">3. Joinpoint（连接点）</span></span><br><span class="line"><span class="code">		目标对象中的可被增强的所有方法(被代理类中的所有方法)  </span></span><br><span class="line"><span class="code">		1). JDKProxy中被代理类不可被增强方法 (父接口没有的方法)</span></span><br><span class="line"><span class="code">		2). CGlib中被代理类不可被增强方法(用final修饰的方法)</span></span><br><span class="line"><span class="code">4. Pointcut（切入点）</span></span><br><span class="line"><span class="code">		要被增强的方法(被代理类中要增强的方法)   </span></span><br><span class="line"><span class="code">		1). 切入点一定是连接点</span></span><br><span class="line"><span class="code">		2). 但连接点不一定是切入点</span></span><br><span class="line"><span class="code">5. Advice（通知/增强)</span></span><br><span class="line"><span class="code">	    通知是增强的那段代码形成的方法</span></span><br><span class="line"><span class="code">        1). 前置通知 在方法之前进行增强</span></span><br><span class="line"><span class="code">        2). 后置通知 在方法之后进行增强</span></span><br><span class="line"><span class="code">		3). 异常通知 在方法异常进行增强</span></span><br><span class="line"><span class="code">		4). 最终通知 最终执行的方法进行增强</span></span><br><span class="line"><span class="code">        5). 环绕通知 单独使用（以上所有通知）</span></span><br><span class="line"><span class="code">6. Aspect(切面) </span></span><br><span class="line"><span class="code">		切面= 切入点+通知</span></span><br><span class="line"><span class="code">		目标方法和增强方法合到在一起 叫做切面</span></span><br><span class="line"><span class="code">7. Weaving（织入）</span></span><br><span class="line"><span class="code">		在运行过程中,spring底层将通知和切入点进行整合的过程,称为织入</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p>这些概念,以刚才的动态代理代码给大家描述</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1610093590335.png"
                      alt="1610093590335"
                > </p>
<h3 id="2-2-2-AOP开发过程"><a href="#2-2-2-AOP开发过程" class="headerlink" title="2.2.2 )AOP开发过程"></a>2.2.2 )AOP开发过程</h3><ul>
<li>开发阶段(开发者完成)<ul>
<li>正常的制作程序</li>
<li>将非共性功能开发到对应的目标对象类中，并制作成切入点方法</li>
<li>将共性功能独立开发出来，制作成<strong>通知</strong></li>
<li>在配置类中，声明<strong>切入点</strong></li>
<li>在配置类中，声明<strong>切入点</strong>与<strong>通知</strong>间的关系（含<strong>通知类型</strong>），即<strong>切面</strong></li>
</ul>
</li>
<li>运行阶段(AOP完成)<ul>
<li>Spring容器加载配置文件时, 使用<strong>代理</strong>机制，动态创建<strong>目标对象</strong>的<strong>代理对象</strong>,根据<strong>通知类别</strong>，在<strong>代理对象</strong>的对应位置将<strong>通知</strong>对应的功能<strong>织入</strong>，形成完整的代码逻辑</li>
<li>当<strong>切入点</strong>方法被运行，将会调用代理对象的方法,达到增强目标对象的效果</li>
</ul>
</li>
</ul>
<h3 id="2-2-3-AOP开发方式"><a href="#2-2-3-AOP开发方式" class="headerlink" title="2.2.3 )AOP开发方式"></a>2.2.3 )AOP开发方式</h3><ul>
<li>XML方式</li>
<li>注解方式 (我们学习这个即可)</li>
</ul>
<h2 id="2-3-AOP配置-重点"><a href="#2-3-AOP配置-重点" class="headerlink" title="2.3 )AOP配置 (重点)"></a>2.3 )AOP配置 (重点)</h2><h3 id="2-3-1-入门案例"><a href="#2-3-1-入门案例" class="headerlink" title="2.3.1) 入门案例"></a>2.3.1) 入门案例</h3><p>1.导入相关坐标</p>
<p>2.确认要增强的功能，并将其制作成方法保存到专用的类中</p>
<p>3.配置将所有要进行AOP操作的资源以及AOP相关设置 (核心)</p>
<p>4.编写测试类, 运行程序</p>
<blockquote>
<p>备注:我们入门案例都用xml配置,后续演示注解配置</p>
</blockquote>
<p><strong>代码实现</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1638025838746.png"
                      alt="1638025838746"
                > </p>
<h4 id="步骤1"><a href="#步骤1" class="headerlink" title="步骤1"></a>步骤1</h4><p>​    导入坐标和原始设计(需要增强的类)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- spring核心jar包,已经依赖的AOP的jar --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- <span class="doctag">TODO:</span> 切入点表达式 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有返回值</span></span><br><span class="line">    String <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//有参数</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountService;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;findAll.............&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;result: 查询结果&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(String str)</span> &#123;</span><br><span class="line"><span class="comment">//        int i = 1/0;</span></span><br><span class="line">        System.out.println(<span class="string">&quot;insert.............&quot;</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;update.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;delete.............&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="步骤2"><a href="#步骤2" class="headerlink" title="步骤2"></a>步骤2</h4><p>编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//包扫描</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.itheima&quot;)</span></span><br><span class="line"><span class="comment">// 开启aop注解支持</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="步骤3"><a href="#步骤3" class="headerlink" title="步骤3"></a>步骤3</h4><p>​    确认要增强的功能，并将其制作成方法保存到专用的类中</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 切面类中注解：</span></span><br><span class="line"><span class="bullet">1.</span> 配置切面类</span><br><span class="line"><span class="code">    1). @Aspect配置当前类为切面类(切入点+通知)</span></span><br><span class="line"><span class="code">    2). 示例</span></span><br><span class="line"><span class="code">        @Aspect</span></span><br><span class="line"><span class="code">        public class MyAdvice &#123;</span></span><br><span class="line"><span class="code">        	...</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">2. 配置切入点</span></span><br><span class="line"><span class="code">	1). @PonitCut：定义公共的切入点</span></span><br><span class="line"><span class="code">	2). 示例</span></span><br><span class="line"><span class="code">		@Aspect</span></span><br><span class="line"><span class="code">		public class MyAdvice &#123;</span></span><br><span class="line"><span class="code">			// 配置到空方法上，value：切入点表达式</span></span><br><span class="line"><span class="code">			// 引用：方法名()</span></span><br><span class="line"><span class="code">            @Pointcut(&quot;execution(* com.itheima..AccountServiceImpl.*(..))&quot;)</span></span><br><span class="line"><span class="code">            public void pt()&#123;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">         &#125; </span></span><br><span class="line"><span class="code">		</span></span><br><span class="line"><span class="code">3. 配置通知类型</span></span><br><span class="line"><span class="code">	1). 注解</span></span><br><span class="line"><span class="code">        @Before: 前置通知</span></span><br><span class="line"><span class="code">        @AfterReturning：后置通知</span></span><br><span class="line"><span class="code">        @AfterThrowing ：异常通知</span></span><br><span class="line"><span class="code">        @After ：最终通知</span></span><br><span class="line"><span class="code">        @Around：环绕通知</span></span><br><span class="line"><span class="code">    2). 示例</span></span><br><span class="line"><span class="code">    		//value=调用切入点方法</span></span><br><span class="line"><span class="code">            @Around(&quot;pt()&quot;)</span></span><br><span class="line"><span class="code">            public Object around(ProceedingJoinPoint pjp)&#123;</span></span><br><span class="line"><span class="code">                ...</span></span><br><span class="line"><span class="code">            &#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">//IOC配置: 当前bean需要加载到ioc容器中</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//aop配置 : 声明当前类是切面类 (切面=切入点+通知)</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        指定切入点 : 指定AccountServiceImpl类中所有方法为切入点 (切入点表达式)</span></span><br><span class="line"><span class="comment">        1. @Pointcut配置切入点</span></span><br><span class="line"><span class="comment">        2. 需要写在一个三无方法上 (无参无返回值空方法体)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.itheima.service.impl.AccountServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;前置通知:11111111111111111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;后置通知:2222222222222222&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowing</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异常通知:3333333333333333333&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;最终通知:44444444444444444444444&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="步骤4"><a href="#步骤4" class="headerlink" title="步骤4"></a>步骤4</h4><p> 测试类 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//spring整合junit</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//加载注解配置类</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountService service;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(service);</span><br><span class="line">        System.out.println(service.getClass());</span><br><span class="line">        <span class="comment">//配置对insert方法具有增强效果</span></span><br><span class="line">        service.insert(<span class="string">&quot;参数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<blockquote>
<p>before: 前置通知<br>insert………….参数<br>afterReturning:后置通知<br>after: 最终通知</p>
</blockquote>
<h3 id="2-3-2-案例详解"><a href="#2-3-2-案例详解" class="headerlink" title="2.3.2) 案例详解"></a>2.3.2) 案例详解</h3><h4 id="2-3-2-1-案例分析"><a href="#2-3-2-1-案例分析" class="headerlink" title="2.3.2.1) 案例分析"></a>2.3.2.1) 案例分析</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 入门案例代码步骤</span></span><br><span class="line"><span class="bullet">1.</span> 导入依赖 spring</span><br><span class="line"><span class="bullet">2.</span> 编写service接口 + 实现类(目标对象 : 连接点)</span><br><span class="line"><span class="bullet">3.</span> 通知类 (其实是切面=切入点+通知)</span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code"># 入门案例执行原理</span></span><br><span class="line"><span class="code">1. 创建目标对象target</span></span><br><span class="line"><span class="code">	1). ioc配置 </span></span><br><span class="line"><span class="code">		目标对象 AccountServiceImpl</span></span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code">2. 创建代理对象proxy(切面=通知+切入点)</span></span><br><span class="line"><span class="code">	1). 基于目标对象  -&gt; 代理类</span></span><br><span class="line"><span class="code">	2). 基于MyAdvice -&gt; 代理类方法体</span></span><br><span class="line"><span class="code">    	切面=切入点+通知</span></span><br><span class="line"><span class="code">    3). Weaving（织入）</span></span><br><span class="line"><span class="code">		在运行过程中,spring底层将通知和切入点进行整合的过程,称为织入</span></span><br><span class="line"><span class="code">		</span></span><br><span class="line"><span class="code">3. 调用代理对象方法</span></span><br><span class="line"><span class="code">	 @Autowired</span></span><br><span class="line"><span class="code">    AccountService service; // 代理对象</span></span><br><span class="line"><span class="code">    service.insert(&quot;参数&quot;);</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    </span></span><br></pre></td></tr></table></figure>



<h4 id="2-3-2-2-切入点表达式"><a href="#2-3-2-2-切入点表达式" class="headerlink" title="2.3.2.2) 切入点表达式"></a>2.3.2.2) 切入点表达式</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1. 切入点表达式</span></span><br><span class="line"><span class="code">	1). 通过切入点表达式可以让spring找到所要监控的切入点</span></span><br><span class="line"><span class="code">	2). 依赖</span></span><br><span class="line"><span class="code">		 &lt;!-- 切入点表达式 --&gt;</span></span><br><span class="line"><span class="code">        &lt;dependency&gt;</span></span><br><span class="line"><span class="code">            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">            &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">            &lt;version&gt;1.9.4&lt;/version&gt;</span></span><br><span class="line"><span class="code">        &lt;/dependency&gt;</span></span><br><span class="line"><span class="code"># 2. 语法		</span></span><br><span class="line"><span class="code">1. 完整写法：execution(方法的修饰符 方法的返回值 类的全限定名.方法名(参数))</span></span><br><span class="line"><span class="code">2. 支持通配符的写法：</span></span><br><span class="line"><span class="code">	1) *   标识任意字符串</span></span><br><span class="line"><span class="code">	2) ..  任意重复次数</span></span><br><span class="line"><span class="code">3. 规则	</span></span><br><span class="line"><span class="code">    1. 方法的修饰符可以省略：</span></span><br><span class="line"><span class="code">    2. 返回值可以使用*号代替：标识任意返回值类型</span></span><br><span class="line"><span class="code">    3. 包名可以使用*号代替，代表任意包（一层包使用一个*）</span></span><br><span class="line"><span class="code">    4. 使用..配置包名，标识此包以及此包下的所有子包</span></span><br><span class="line"><span class="code">    5. 类名可以使用*号代替，标识任意类</span></span><br><span class="line"><span class="code">    6. 方法名可以使用*号代替，表示任意方法</span></span><br><span class="line"><span class="code">    7. 可以使用..配置参数，任意参数</span></span><br><span class="line"><span class="code"># 3. 示例</span></span><br><span class="line"><span class="code">1. 完整写法：execution(方法的修饰符 方法的返回值 类的全限定名.方法名(参数))</span></span><br><span class="line"><span class="code">		public void com.itheima.service.impl.AccountServiceImpl.insert(String)</span></span><br><span class="line"><span class="code">2. 支持通配符的写法：</span></span><br><span class="line"><span class="code">	1) *   标识任意字符串</span></span><br><span class="line"><span class="code">	2) ..  任意重复次数</span></span><br><span class="line"><span class="code">3. 规则	</span></span><br><span class="line"><span class="code">    1. 方法的修饰符可以省略：</span></span><br><span class="line"><span class="code">            execution(void com.itheima.service.impl.AccountServiceImpl.insert(String))</span></span><br><span class="line"><span class="code">        2. 返回值可以使用*号代替：标识任意返回值类型</span></span><br><span class="line"><span class="code">           execution(* com.itheima.service.impl.AccountServiceImpl.insert(String))</span></span><br><span class="line"><span class="code">        3. 包名可以使用*号代替，代表任意包（一层包使用一个*）</span></span><br><span class="line"><span class="code">            execution(* com.*.*.*.AccountServiceImpl.insert(String))</span></span><br><span class="line"><span class="code">        4. 使用..配置包名，标识此包以及此包下的所有子包</span></span><br><span class="line"><span class="code">                 execution(* com..AccountServiceImpl.insert(String))</span></span><br><span class="line"><span class="code">        5. 类名可以使用*号代替，标识任意类</span></span><br><span class="line"><span class="code">                execution(* com..*.insert(String))</span></span><br><span class="line"><span class="code">        6. 方法名可以使用*号代替，表示任意方法</span></span><br><span class="line"><span class="code">                 execution(* com..*.*(String))</span></span><br><span class="line"><span class="code">        7. 可以使用..配置参数，任意参数</span></span><br><span class="line"><span class="code">                 execution(* com..*.*(..))</span></span><br><span class="line"><span class="code"># 推荐: (在需求范围,越具体越好,效率高)</span></span><br><span class="line"><span class="code">                //service包下的所有方法,均为切入点</span></span><br><span class="line"><span class="code">               execution(void com.itheima.service..*.*(..))</span></span><br><span class="line"><span class="code">                //service包下的任意Service(比如UserService,AccountService...)下的所有方法</span></span><br><span class="line"><span class="code">               execution(void com.itheima.service.*Service.*(..))</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-3-通知类型"><a href="#2-3-2-3-通知类型" class="headerlink" title="2.3.2.3) 通知类型"></a>2.3.2.3) 通知类型</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1. AOP的通知类型共5种</span></span><br><span class="line"><span class="bullet">    1.</span> 前置通知</span><br><span class="line"><span class="code">    	原始方法(切入点)执行前执行，如果通知中抛出异常，阻止原始方法运行</span></span><br><span class="line"><span class="code">      	应用：数据校验</span></span><br><span class="line"><span class="code">    2. 后置通知：原始方法执行后执行，无论原始方法中是否出现异常，不再执行</span></span><br><span class="line"><span class="code">      	应用：返回值相关数据处理</span></span><br><span class="line"><span class="code">    3. 抛出异常后通知：原始方法抛出异常后执行，如果原始方法没有抛出异常，无法执行</span></span><br><span class="line"><span class="code">      	应用：对原始方法中出现的异常信息进行处理</span></span><br><span class="line"><span class="code">    4. 最终通知：无论如何最终都执行</span></span><br><span class="line"><span class="code">      	应用：现场清理</span></span><br><span class="line"><span class="code">    5. 环绕通知：在原始方法执行前后均有对应执行，还可以阻止原始方法的执行</span></span><br><span class="line"><span class="code">      	应用：十分强大，可以做包括四种类型的所有事情</span></span><br><span class="line"><span class="code"># 2. 对应的标签</span></span><br><span class="line"><span class="code">	以下标签均归属aop:aspect标签</span></span><br><span class="line"><span class="code">	1. @Before(&quot;pt()&quot;)  (前置通知)</span></span><br><span class="line"><span class="code">	2. @AfterReturning(&quot;pt()&quot;) (后置通知)</span></span><br><span class="line"><span class="code">	3. @AfterThrowing(&quot;pt()&quot;) (抛出异常后通知)</span></span><br><span class="line"><span class="code">	4. @After(&quot;pt()&quot;)(最终通知)</span></span><br><span class="line"><span class="code">	5. @Around(&quot;pt()&quot;)</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 环绕通知的开发方式</span></span><br><span class="line"><span class="bullet">1.</span> 环绕通知是在原始方法的前后添加功能，在环绕通知中，存在对原始方法的显式调用</span><br><span class="line"><span class="code">          public Object around(ProceedingJoinPoint pjp) throws Throwable &#123;</span></span><br><span class="line"><span class="code">              Object ret = pjp.proceed();</span></span><br><span class="line"><span class="code">              return ret;</span></span><br><span class="line"><span class="code">          &#125;</span></span><br><span class="line"><span class="code">2. 环绕通知方法相关说明：</span></span><br><span class="line"><span class="code">  1).方法须设定Object类型的返回值，否则会拦截原始方法的返回。如果原始方法返回值类型为void，通知方	也可以设定返回值类型为void，最终返回null</span></span><br><span class="line"><span class="code">  2). 方法需在第一个参数位置设定ProceedingJoinPoint对象(代表切入点)，通过该对象调用proceed()方法，实现对原始方法的调用。如省略该参数，原始方法将无法执行</span></span><br><span class="line"><span class="code">  3). 使用proceed()方法调用原始方法时，因无法预知原始方法运行过程中是否会出现异常，强制抛出Throwable对象，封装原始方法中可能出现的异常信息</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p><strong>示例代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    <span class="doctag">TODO:</span> 环绕通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice3</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.itheima.service..*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @After(&quot;pt()&quot;)</span></span><br><span class="line"><span class="comment">//    public void after()&#123;</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;最终通知:44444444444444444444444&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        环绕通知 : 整合了所有其他通知</span></span><br><span class="line"><span class="comment">        1. 参数</span></span><br><span class="line"><span class="comment">            1). ProceedingJoinPoint 表示切入点</span></span><br><span class="line"><span class="comment">                相当于Method,只不过比method的封装度更高</span></span><br><span class="line"><span class="comment">            2). Object result = pjp.proceed();</span></span><br><span class="line"><span class="comment">                执行的是切入点方法</span></span><br><span class="line"><span class="comment">               相当于 Object result =  method.invoke(...)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        2. 返回值</span></span><br><span class="line"><span class="comment">            代理对象的执行方法的返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;前置通知&quot;</span>);</span><br><span class="line">            <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> pjp.getSignature(); <span class="comment">//获取切入点的方法</span></span><br><span class="line">            Object[] args = pjp.getArgs(); <span class="comment">// 获取切入点的参数</span></span><br><span class="line">            System.out.println(signature);</span><br><span class="line">            System.out.println(Arrays.toString(args));</span><br><span class="line">            result = pjp.proceed();</span><br><span class="line">            System.out.println(<span class="string">&quot;后置通知&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line"><span class="comment">//            throwable.printStackTrace();</span></span><br><span class="line">            System.out.println(<span class="string">&quot;异常通知&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;最终通知&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<blockquote>
<p>前置<br>insert………….参数<br>后置<br>最终</p>
</blockquote>
<h2 id="2-4-AOP小练习"><a href="#2-4-AOP小练习" class="headerlink" title="2.4) AOP小练习"></a>2.4) AOP小练习</h2><p>计算service层所有find开头方法执行10000次的耗时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">// 切面 = 切入点 + 通知</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice4</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.itheima.service.*Service.find*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">                result = pjp.proceed();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> pjp.getSignature();</span><br><span class="line">            System.out.println(signature + <span class="string">&quot;-&gt;&quot;</span> + (end-start));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.config.SpringConfig;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.AccountServiceClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes= SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApp2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代理类对象</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountService service; <span class="comment">// 基于接口,底层是jdk proxy</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="comment">//使用aop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> service.findAll();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//没有使用aop</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> service.findAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(end - start);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="3-事务"><a href="#3-事务" class="headerlink" title="3. 事务"></a>3. 事务</h1><h2 id="3-1-事务回顾"><a href="#3-1-事务回顾" class="headerlink" title="3.1) 事务回顾"></a>3.1) 事务回顾</h2><h3 id="3-1-1-事务介绍"><a href="#3-1-1-事务介绍" class="headerlink" title="3.1.1)事务介绍"></a>3.1.1)事务介绍</h3><p>transaction(事务)</p>
<blockquote>
<p>一组操作,要么同时成功,要么同时失败</p>
</blockquote>
<p>​    是数据库操作的最小工作单元，是作为单个逻辑工作单元执行的一系列操作，这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行；事务是一组不可再分割的操作集合 </p>
<blockquote>
<p>开启事务</p>
<p>业务操作…</p>
<p>成功提交 &#x2F; 失败回滚</p>
</blockquote>
<h3 id="3-1-2-事务的特点"><a href="#3-1-2-事务的特点" class="headerlink" title="3.1.2)事务的特点"></a>3.1.2)事务的特点</h3><blockquote>
<p>CRUD:  增删改查(create retrieve&#x2F;read  update  delete)</p>
</blockquote>
<ul>
<li>事务特征（ACID）<ul>
<li>原子性（Atomicity）指事务是一个不可分割的整体，其中的操作要么全执行或全不执行</li>
<li>一致性（Consistency）事务前后数据的完整性必须保持一致</li>
<li>隔离性（Isolation）事务的隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离</li>
<li>持久性（Durability）持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响</li>
</ul>
</li>
</ul>
<h3 id="3-1-3-事务的隔离级别"><a href="#3-1-3-事务的隔离级别" class="headerlink" title="3.1.3)事务的隔离级别"></a>3.1.3)事务的隔离级别</h3><table>
<thead>
<tr>
<th>隔离级别</th>
<th>说明</th>
<th align="center">脏读</th>
<th align="center">不可重复读</th>
<th align="center">幻读</th>
</tr>
</thead>
<tbody><tr>
<td>ISOLATION_READ_UNCOMMITTED</td>
<td>读未提交</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td>ISOLATION_READ_COMMITTED</td>
<td>读已提交</td>
<td align="center">×</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td>ISOLATION_REPEATABLE_READ</td>
<td>可重复读</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">√</td>
</tr>
<tr>
<td>ISOLATION_SERIALIZABLE</td>
<td>串行化操作</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
</tr>
</tbody></table>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 隔离级别</span></span><br><span class="line"><span class="bullet">1.</span> 隔离级别由低到高</span><br><span class="line"><span class="code">	【READ_UNCOMMITTED】=&gt;【READ_COMMITTED】=&gt;【REPEATABLE_READ】=&gt;【SERIALIZABLE】</span></span><br><span class="line"><span class="code">2. 数据库的默认级别</span></span><br><span class="line"><span class="code">	1). 对大多数数据库来说就是：READ_COMMITTED(读已提交)</span></span><br><span class="line"><span class="code">	2). MySQL默认采用：REPEATABLE_READ(可重复读)，</span></span><br><span class="line"><span class="code">	3). Oracle采用：READ__COMMITTED(读已提交) </span></span><br><span class="line"><span class="code">		</span></span><br><span class="line"><span class="code"># 事务并发产生的三个问题</span></span><br><span class="line"><span class="code">1. 脏读：允许读取未提交的信息</span></span><br><span class="line"><span class="code">	脏数据(dirty data) : 正在编辑中的数据</span></span><br><span class="line"><span class="code">  - 原因：Read uncommitted</span></span><br><span class="line"><span class="code">  - 解决方案： Read committed</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">2.  不可重复读：读取过程中单个数据发生了变化</span></span><br><span class="line"><span class="code">  - 解决方案： Repeatable read</span></span><br><span class="line"><span class="code">  </span></span><br><span class="line"><span class="code">3.  幻读：读取过程中数据条目发生了变化</span></span><br><span class="line"><span class="code">  - 解决方案： Serializable</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-转账案例"><a href="#3-2-转账案例" class="headerlink" title="3.2). 转账案例"></a>3.2). 转账案例</h2><p>为了更好的说明spring中的事务操作,我们用已学过的知识模拟一个转账场景</p>
<p>数据库准备</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database spring_db;</span><br><span class="line">use spring_db;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> account(</span><br><span class="line">	id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">	money <span class="keyword">double</span>	</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="number">1000</span>),(<span class="keyword">null</span>,<span class="string">&#x27;rose&#x27;</span>,<span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(导入素材中的代码day03-transfer)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1638027391080.png"
                      alt="1638027391080"
                ></p>
<p> jdbc.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_db</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">getSqlSessionFactoryBean</span><span class="params">(DataSource ds)</span>&#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        <span class="comment">//设置pojo的包扫描</span></span><br><span class="line">        factoryBean.setTypeAliasesPackage(<span class="string">&quot;com.itheima.pojo&quot;</span>);</span><br><span class="line">        <span class="comment">//设置连接池</span></span><br><span class="line">        factoryBean.setDataSource(ds);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MapperScannerConfigurer <span class="title function_">mapperScannerConfigurer</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MapperScannerConfigurer</span> <span class="variable">msc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">        <span class="comment">//设置dao层的接口扫描</span></span><br><span class="line">        msc.setBasePackage(<span class="string">&quot;com.itheima.dao&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> msc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.itheima&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(MybatisConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(username);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, money=&quot;</span> + money +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getMoney</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMoney</span><span class="params">(Double money)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line">    <span class="comment">//转出</span></span><br><span class="line">    <span class="meta">@Update(&quot;update account set money = money - #&#123;money&#125; where id = #&#123;outId&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">outMoney</span><span class="params">(<span class="meta">@Param(&quot;outId&quot;)</span> <span class="type">int</span> outId, <span class="meta">@Param(&quot;money&quot;)</span><span class="type">double</span> money)</span>;</span><br><span class="line">    <span class="comment">//转入</span></span><br><span class="line">    <span class="meta">@Update(&quot;update account set money = money + #&#123;money&#125; where id = #&#123;inId&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">inMoney</span><span class="params">(<span class="meta">@Param(&quot;inId&quot;)</span> <span class="type">int</span> inId, <span class="meta">@Param(&quot;money&quot;)</span><span class="type">double</span> money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">//转账业务</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId,<span class="type">int</span> inId,<span class="type">double</span> money)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao dao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId, <span class="type">int</span> inId, <span class="type">double</span> money)</span> &#123;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dao.outMoney(outId, money);</span><br><span class="line">            <span class="comment">//可能在转账过程中发生意外: 转出执行,转入还未执行</span></span><br><span class="line"><span class="comment">//            int i = 1/0;</span></span><br><span class="line">            dao.inMoney(inId, money);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SpringConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService service;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line">        service.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-Spring声明式事务"><a href="#4-Spring声明式事务" class="headerlink" title="4. Spring声明式事务"></a>4. Spring声明式事务</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Spring声明式事务</span></span><br><span class="line"><span class="bullet">1.</span> 编程式事务: 不用AOP配置,自己写事务</span><br><span class="line"><span class="code">	1). Spring的事务管理(API)	</span></span><br><span class="line"><span class="code">		有点复杂，待会解释</span></span><br><span class="line"><span class="code">	2). 弊端:</span></span><br><span class="line"><span class="code">    	耦合度高,侵入性强, 不利于扩展和维护</span></span><br><span class="line"><span class="code">    	后续如果有其他方法需要业务,依然需要编写代码</span></span><br><span class="line"><span class="code">    	如果现有方法修改事务属性,需要修改代码</span></span><br><span class="line"><span class="code">2. 用AOP改造编程式事务: (用spring配置代替代码)</span></span><br><span class="line"><span class="code">	1). 作用: 不改变原有设计的前提下,增强其方法</span></span><br><span class="line"><span class="code">	2). 优点:;耦合度低, 无侵入性,利于扩展和维护</span></span><br><span class="line"><span class="code">			后续如果有其他方法需要业务,只需要修改配置</span></span><br><span class="line"><span class="code">    		如果现有方法修改事务属性,还需要修改代码</span></span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code">3. 声明式事务(重点)</span></span><br><span class="line"><span class="code">	1). XML配置</span></span><br><span class="line"><span class="code">	2). 注解配置(后面讲)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 编程式事务(了解)</span></span><br><span class="line"><span class="bullet">1.</span> 不用AOP, 自己用spring的api编写事务</span><br><span class="line"><span class="bullet">2.</span> 思路</span><br><span class="line"><span class="code">	I. 操作(跟业务相关)之前开启事务,成功提交,失败回滚</span></span><br><span class="line"><span class="code">	II. service层编写事务代码 (事务根据业务来定义的)</span></span><br><span class="line"><span class="code">	III. 从spring文档抄事务代码</span></span><br><span class="line"><span class="code">	IV. 解释spring事务api</span></span><br><span class="line"><span class="code">3. spring事务api	</span></span><br><span class="line"><span class="code">	I. 事务管理器 : 管理事务</span></span><br><span class="line"><span class="code">		1). 设置的连接池(数据源 dataSource)要跟dao层连接池一致</span></span><br><span class="line"><span class="code">		2). DataSourceTransactionManager (重点!!!)</span></span><br><span class="line"><span class="code">				适用于Spring JDBC或MyBatis </span></span><br><span class="line"><span class="code">			也有其他管理器(hibernate或JPA等dao层框架)	</span></span><br><span class="line"><span class="code">	II. 事务定义对象 : 设置事务属性</span></span><br><span class="line"><span class="code">		1).  td.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);</span></span><br><span class="line"><span class="code">           事务隔离级别: 4个级别,3个问题(一般用中间两个级别)</span></span><br><span class="line"><span class="code">			read_uncommitted, read_committed</span></span><br><span class="line"><span class="code">		 	REPEATABLE_READ,serializable</span></span><br><span class="line"><span class="code">		2). td.setReadOnly(false); 	</span></span><br><span class="line"><span class="code">			false,表示读写均可(默认设置,适合增删改操作)</span></span><br><span class="line"><span class="code">			true,表示只读(适合查,效率高)</span></span><br><span class="line"><span class="code">		3). td.setTimeout(10);</span></span><br><span class="line"><span class="code">			超时连接,默认值是-1, 表示永不超时, 单位是秒</span></span><br><span class="line"><span class="code">        4). td.setPropagationBehavior()	</span></span><br><span class="line"><span class="code">        	设置事务传播行为 (后续解释)</span></span><br><span class="line"><span class="code">	III. 事务状态对象 : 记录当前事务状态</span></span><br><span class="line"><span class="code">		开启, 成功提交, 失败回滚 等状态都记录在这个对象上</span></span><br><span class="line"><span class="code">    	</span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 用AOP改造编程式事务</span></span><br><span class="line"><span class="bullet">1.</span> 问题: 如果我们要进行事务增强的方法有多个,编程式事务代码需要重复书写,太冗余了</span><br><span class="line"><span class="bullet">2.</span> 解决: AOP (底层采用动态代理,在不惊动原始的设计前提下,增强其方法)</span><br><span class="line"><span class="bullet">3.</span> 目的: 对service的方法进行事务增强</span><br><span class="line"><span class="code">	1). 前置增强 : 开启事务</span></span><br><span class="line"><span class="code">	2). 后置增强 : 提交事务</span></span><br><span class="line"><span class="code">	3). 异常增强 : 回滚事务</span></span><br><span class="line"><span class="code">	环绕通知搞定一切</span></span><br><span class="line"><span class="code">4. 做法: </span></span><br><span class="line"><span class="code">	1). 目标对象</span></span><br><span class="line"><span class="code">		service的transfer方法只专注业务,异常不能try...catch</span></span><br><span class="line"><span class="code">	2). 通知类</span></span><br><span class="line"><span class="code">		TxAdvice(环绕通知)</span></span><br><span class="line"><span class="code">	3). 切面配置</span></span><br><span class="line"><span class="code">		</span></span><br><span class="line"><span class="code">5. transfer方法内部为何不能try...catch,有异常只能往外抛呢?</span></span><br><span class="line"><span class="code">     因为此方法(切入点)最终要被织入到切面中</span></span><br><span class="line"><span class="code">     切面的异常通知,需要catch异常才能执行</span></span><br><span class="line"><span class="code">     如果transfer方法自己catch,切面的catch就无法执行了</span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 声明式事务(重点)</span></span><br><span class="line"><span class="bullet">1.</span> 问题: aop改造编程式事务, TxAdvice通知类的编写不具备特例性</span><br><span class="line"><span class="code">		写切入点(特例) + TxAdvice + AOP配置</span></span><br><span class="line"><span class="code">2. 解决: </span></span><br><span class="line"><span class="code">		Spring底层已经写好TxAdvice,我们就不需要写TxAdvice</span></span><br><span class="line"><span class="code">		只需要配置即可使用</span></span><br><span class="line"><span class="code">		所谓声明式事务,声明即可用(事务配置即可)</span></span><br><span class="line"><span class="code">		</span></span><br></pre></td></tr></table></figure>



<p>spring事务有以下三种实现方式,其中编程式事务作为了解,<strong>声明式事务是重点</strong></p>
<ul>
<li>编程式</li>
<li>声明式（注解）</li>
</ul>
<h2 id="4-1-编程式事务-了解"><a href="#4-1-编程式事务-了解" class="headerlink" title="4.1 编程式事务(了解)"></a>4.1 编程式事务(了解)</h2><p>以下用spring提供的api进行事务管理,修改AccountServiceImpl 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    TODO : Spring编程式事务</span></span><br><span class="line"><span class="comment">    1. 解释: 用Spring中的事务相关API用编码的方式来实现事务</span></span><br><span class="line"><span class="comment">    2. 但是这样实现不好: 耦合严重</span></span><br><span class="line"><span class="comment">        1). 事务管理代码跟业务代码耦合在一起</span></span><br><span class="line"><span class="comment">        2). 如果后续还有其他业务方法需要事务, 还得一个个编写事务代码,很冗余</span></span><br><span class="line"><span class="comment">    3. 解决方案: </span></span><br><span class="line"><span class="comment">        AOP </span></span><br><span class="line"><span class="comment">        1). 特点: 在不惊动原始设计的前提下,增强方法</span></span><br><span class="line"><span class="comment">        2). 概述: 无侵入性, 解耦    </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl2</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao dao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId, <span class="type">int</span> inId, <span class="type">double</span> money)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 创建事务管理器</span></span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">dstm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        <span class="comment">//为事务管理器设置与数据层相同的数据源!!!</span></span><br><span class="line">        dstm.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//2. 创建事务定义对象 : 隔离级别/传播特性/超时时间...</span></span><br><span class="line">        <span class="type">DefaultTransactionDefinition</span> <span class="variable">td</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>();</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">                设置事务隔离级别</span></span><br><span class="line"><span class="comment">                    0). spring默认隔离级别是跟数据库软件一致 (ISOLATION_DEFAULT)</span></span><br><span class="line"><span class="comment">                    1). mysql默认是REPEATABLE_READ</span></span><br><span class="line"><span class="comment">                    2). oracle默认是READ_COMMITTED</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        td.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            *   设置是否为只读事务</span></span><br><span class="line"><span class="comment">            *      1). false,表示读写均可(默认设置,适合增删改操作)</span></span><br><span class="line"><span class="comment">                   2). true,表示只读(适合查,效率高)</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">        td.setReadOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   设置超时时间</span></span><br><span class="line"><span class="comment">         *      1). 默认值是-1, 表示永不超时</span></span><br><span class="line"><span class="comment">         *      2). 单位是秒</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        td.setTimeout(<span class="number">10</span>);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                设置事务传播行为</span></span><br><span class="line"><span class="comment">                    1. 一般增删改：REQUIRED (默认值)</span></span><br><span class="line"><span class="comment">                    2. 一般查询  SUPPORTS</span></span><br><span class="line"><span class="comment">                    这个比较复杂,待会详解</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">        td.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line">        <span class="comment">//3.创建事务状态对象，用于控制事务执行(了解)  -&gt; 相当于开启事务</span></span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">ts</span> <span class="operator">=</span> dstm.getTransaction(td);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dao.outMoney(outId, money);</span><br><span class="line">            <span class="comment">//可能在转账过程中发生意外: 转出执行,转入还未执行</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            dao.inMoney(inId, money);</span><br><span class="line"></span><br><span class="line">            dstm.commit(ts);<span class="comment">//成功,提交</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            dstm.rollback(ts);<span class="comment">//失败,回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-2-AOP改造编程式事务-了解"><a href="#4-2-AOP改造编程式事务-了解" class="headerlink" title="4.2 AOP改造编程式事务(了解)"></a>4.2 AOP改造编程式事务(了解)</h2><p>​    我们刚才采取了在方法中硬编码的形式编写了事务,但是一旦业务层新增其他需要事务的操作,我们就还需要重新编写代码,这样代码就比较冗余了,现在用AOP进行改造.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.itheima&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(MybatisConfig.class)</span></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 开启aop支持 !!!</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(username);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/*   @Override</span></span><br><span class="line"><span class="comment">    public void transfer(int outId, int inId, double money) &#123;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            dao.outMoney(outId, money);</span></span><br><span class="line"><span class="comment">            //可能在转账过程中发生意外: 转出执行,转入还未执行</span></span><br><span class="line"><span class="comment">            int i = 1/0;</span></span><br><span class="line"><span class="comment">            dao.inMoney(inId, money);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">        注意: 在aop使用中,切入点方法千万不能自己catch异常</span></span><br><span class="line"><span class="comment">        原因: 如果切入点自己catch了异常,那么通知中是调用切入点的地方是不会感知到异常,就不会执行catch了</span></span><br><span class="line"><span class="comment">             (相当于异常通知失效)</span></span><br><span class="line"><span class="comment">        解决方案:</span></span><br><span class="line"><span class="comment">            A方案: 有异常直接抛出,不要catch</span></span><br><span class="line"><span class="comment">            B方案: 可以catch,但是再new一个异常抛出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId, <span class="type">int</span> inId, <span class="type">double</span> money)</span> &#123;</span><br><span class="line">            dao.outMoney(outId, money);</span><br><span class="line">            <span class="comment">//可能在转账过程中发生意外: 转出执行,转入还未执行</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">            dao.inMoney(inId, money);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.DefaultTransactionDefinition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    tx是transaction的缩写</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TxAdvice</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.itheima.service.*Service.transfer(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//1. 创建事务管理器</span></span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">dstm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        <span class="comment">//为事务管理器设置与数据层相同的数据源!!!</span></span><br><span class="line">        dstm.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//2. 创建事务定义对象 : 隔离级别/传播特性/超时时间...</span></span><br><span class="line">        <span class="type">DefaultTransactionDefinition</span> <span class="variable">td</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTransactionDefinition</span>();</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">                设置事务隔离级别</span></span><br><span class="line"><span class="comment">                    0). spring默认隔离级别是跟数据库软件一致 (ISOLATION_DEFAULT)</span></span><br><span class="line"><span class="comment">                    1). mysql默认是REPEATABLE_READ</span></span><br><span class="line"><span class="comment">                    2). oracle默认是READ_COMMITTED</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        td.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            *   设置是否为只读事务</span></span><br><span class="line"><span class="comment">            *      1). false,表示读写均可(默认设置,适合增删改操作)</span></span><br><span class="line"><span class="comment">                   2). true,表示只读(适合查,效率高)</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">        td.setReadOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *   设置超时时间</span></span><br><span class="line"><span class="comment">         *      1). 默认值是-1, 表示永不超时</span></span><br><span class="line"><span class="comment">         *      2). 单位是秒</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        td.setTimeout(<span class="number">10</span>);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                设置事务传播行为</span></span><br><span class="line"><span class="comment">                    1. 一般增删改：REQUIRED (默认值)</span></span><br><span class="line"><span class="comment">                    2. 一般查询  SUPPORTS</span></span><br><span class="line"><span class="comment">                    这个比较复杂,待会详解</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">        td.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line">        <span class="comment">//3.创建事务状态对象，用于控制事务执行(了解)  -&gt; 相当于开启事务</span></span><br><span class="line">        <span class="type">TransactionStatus</span> <span class="variable">ts</span> <span class="operator">=</span> dstm.getTransaction(td);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = pjp.proceed();</span><br><span class="line">            dstm.commit(ts);<span class="comment">//成功,提交</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">            dstm.rollback(ts);<span class="comment">//失败,回滚</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="4-3-声明式事务-重点"><a href="#4-3-声明式事务-重点" class="headerlink" title="4.3 声明式事务(  重点)"></a>4.3 声明式事务(  重点)</h2><p>AOP配置事务不具备特例性(通俗的说,任何业务添加事务都是一样的操作)</p>
<blockquote>
<p>之前写的事务通知类具备通用性的(除了个别属性不一样)</p>
</blockquote>
<p>所以Spring底层封装了事务通知类,直接配置即可用(称为<strong>声明式事务</strong>)</p>
<p>也就说, 我们刚才案例中的<strong>TxAdvice类+相应的AOP</strong>配置可以不写了,用以下的配置代替</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.itheima&quot;)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@Import(MybatisConfig.class)</span></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 开启aop注解支持</span></span><br><span class="line"><span class="comment">//@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 开启事务管理支持 (声明式事务的第一步)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">getDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        ds.setDriverClassName(driver);</span><br><span class="line">        ds.setUrl(url);</span><br><span class="line">        ds.setUsername(username);</span><br><span class="line">        ds.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> 配置事务管理器 (声明式事务的第二步)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">getTxManager</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        manager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   <span class="doctag">TODO:</span>  Spring声明式事务</span></span><br><span class="line"><span class="comment">        问题 : TxAdvice是事务切面类的特点</span></span><br><span class="line"><span class="comment">            1. 代码很多</span></span><br><span class="line"><span class="comment">            2. 事务操作不具备特例性</span></span><br><span class="line"><span class="comment">        解决: Spring直接封装了TxAdvice类,让开发者不需要再写这个类了</span></span><br><span class="line"><span class="comment">            但是一些设置,可能要根据开发者的需求进行更改</span></span><br><span class="line"><span class="comment">            1.  切入点</span></span><br><span class="line"><span class="comment">            2.  通知</span></span><br><span class="line"><span class="comment">                1). 事务管理器</span></span><br><span class="line"><span class="comment">                 如果开发者dao层使用MyBatis框架, 就让其使用 DataSourceTransactionManager</span></span><br><span class="line"><span class="comment">                 如果开发者dao层使用Hibernate框架, 就让其使用 HibernateTransactionManager</span></span><br><span class="line"><span class="comment">                 ...</span></span><br><span class="line"><span class="comment">                2). 事务属性</span></span><br><span class="line"><span class="comment">                    事务隔离级别 / 只读 / 超时 / 传播行为</span></span><br><span class="line"><span class="comment">       开发步骤:</span></span><br><span class="line"><span class="comment">            1. 注解</span></span><br><span class="line"><span class="comment">                //启动AOP功能 (注释掉)</span></span><br><span class="line"><span class="comment">                //@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="comment">                //开启事务管理器(声明式事务)</span></span><br><span class="line"><span class="comment">                @EnableTransactionManagement</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            2. @Bean 设置  事务管理器</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            3. @Transactional (指定切入点和对应事务属性)</span></span><br><span class="line"><span class="comment">                1). 如果放在类的方法上,说明当前方法是切入点</span></span><br><span class="line"><span class="comment">                2). 如果放在类上,说明当前类的所有方法是切入点</span></span><br><span class="line"><span class="comment">                3). 如果放在接口的方法上,说明此方法的所有重写方法是切入点 (常用)</span></span><br><span class="line"><span class="comment">                4). 如果放在接口上,说明此接口的所有实现类的所有方法都是切入点 (常用)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      <span class="doctag">TODO:</span>   Spring声明式事务</span></span><br><span class="line"><span class="comment">            1. 区别是编程式事务 : 开发者自己编写代码实现事务功能</span></span><br><span class="line"><span class="comment">            2. 声明式事务: spring底层封装了事务切面类, 让开发者声明配置即可用</span></span><br><span class="line"><span class="comment">            IV. 放在实现类的方法上,表示该方法是切入点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> 配置需要事务支持的切入点 (声明式事务的第三步)</span></span><br><span class="line">    <span class="meta">@Transactional(</span></span><br><span class="line"><span class="meta">            isolation = Isolation.DEFAULT,</span></span><br><span class="line"><span class="meta">            readOnly = false,</span></span><br><span class="line"><span class="meta">            timeout = 10,</span></span><br><span class="line"><span class="meta">            propagation = Propagation.REQUIRED</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId,<span class="type">int</span> inId,<span class="type">double</span> money)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-4-Spring事务管理"><a href="#4-4-Spring事务管理" class="headerlink" title="4.4 Spring事务管理"></a>4.4 Spring事务管理</h2><h3 id="4-4-1-Spring事务核心对象"><a href="#4-4-1-Spring事务核心对象" class="headerlink" title="4.4.1)Spring事务核心对象"></a>4.4.1)<strong>Spring</strong>事务核心对象</h3><ul>
<li><p>JAVAEE开发使用分层设计的思想进行</p>
<p>一般dao层只做数据库增删改查实现, 当业务中包含多个dao层的调用时，需要在service层开启事务，对数据层中多个操作进行组合并归属于同一个事务进行处理</p>
</li>
<li><p>Spring为业务层提供了整套的事务解决方案</p>
<ul>
<li><strong>PlatformTransactionManager</strong></li>
<li><strong>TransactionDefinition</strong></li>
<li>TransactionStatus</li>
</ul>
</li>
</ul>
<h3 id="4-4-2-Spring事务相关API"><a href="#4-4-2-Spring事务相关API" class="headerlink" title="4.4.2)Spring事务相关API"></a><strong>4.4.2)Spring事务相关API</strong></h3><h4 id="I-PlatformTransactionManager"><a href="#I-PlatformTransactionManager" class="headerlink" title="I. PlatformTransactionManager"></a><strong>I. PlatformTransactionManager</strong></h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># PlatformTransactionManager(平台事务管理器)</span></span><br><span class="line"><span class="bullet">1.</span> 这是一个接口,以下是实现类</span><br><span class="line"><span class="code">	1). - DataSourceTransactionManager (重点!!!)</span></span><br><span class="line"><span class="code">		适用于Spring JDBC或MyBatis</span></span><br><span class="line"><span class="code">	2). - HibernateTransactionManager </span></span><br><span class="line"><span class="code">    	适用于Hibernate3.0及以上版本  </span></span><br><span class="line"><span class="code">	3). - JpaTransactionManager  </span></span><br><span class="line"><span class="code">		适用于JPA (Java EE 标准之一，为POJO提供持久化标准规范，并规范了持久化开发的统一API，符合JPA规范的开发可以在不同的JPA框架下运行)</span></span><br><span class="line"><span class="code">2. 	此接口定义了事务的基本操作	</span></span><br><span class="line"><span class="code">	1). 获取事务 ：</span></span><br><span class="line"><span class="code">      	TransactionStatus getTransaction(TransactionDefinition definition)</span></span><br><span class="line"><span class="code">	2). 提交事务 ：</span></span><br><span class="line"><span class="code">      	void commit(TransactionStatus status) </span></span><br><span class="line"><span class="code">	3). 回滚事务 ：</span></span><br><span class="line"><span class="code">      	void rollback(TransactionStatus status)</span></span><br><span class="line"><span class="code">3. 示例代码</span></span><br><span class="line"><span class="code">		 //1. 创建事务管理器</span></span><br><span class="line"><span class="code">        DataSourceTransactionManager dstm = new DataSourceTransactionManager();</span></span><br><span class="line"><span class="code">        //2. 为事务管理器设置与数据层相同的数据源</span></span><br><span class="line"><span class="code">        dstm.setDataSource(dataSource);</span></span><br><span class="line"><span class="code">	</span></span><br></pre></td></tr></table></figure>

<h4 id="II-TransactionDefinition接口"><a href="#II-TransactionDefinition接口" class="headerlink" title="II. TransactionDefinition接口"></a><strong>II. TransactionDefinition接口</strong></h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># TransactionDefinition(事务定义)</span></span><br><span class="line"><span class="bullet">1.</span> 实现类</span><br><span class="line"><span class="code">		DefaultTransactionDefinition</span></span><br><span class="line"><span class="code">2. 此接口定义了事务的基本信息</span></span><br><span class="line"><span class="code">  		//2. 创建事务定义对象</span></span><br><span class="line"><span class="code">        DefaultTransactionDefinition td = new DefaultTransactionDefinition();</span></span><br><span class="line"><span class="code">            /*</span></span><br><span class="line"><span class="code">                设置事务隔离级别</span></span><br><span class="line"><span class="code">                    0). spring默认隔离级别是跟数据库软件一致</span></span><br><span class="line"><span class="code">                    1). mysql默认是REPEATABLE_READ</span></span><br><span class="line"><span class="code">                    2). oracle默认是READ_COMMITTED</span></span><br><span class="line"><span class="code">             */</span></span><br><span class="line"><span class="code">        td.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);</span></span><br><span class="line"><span class="code">            /*</span></span><br><span class="line"><span class="code">            *   设置是否只读</span></span><br><span class="line"><span class="code">            *      1). false,表示读写均可(默认设置,适合增删改操作)</span></span><br><span class="line"><span class="code">                   2). true,表示只读(适合查,效率高)</span></span><br><span class="line"><span class="code">            * */</span></span><br><span class="line"><span class="code">        td.setReadOnly(false);</span></span><br><span class="line"><span class="code">            /*</span></span><br><span class="line"><span class="code">            *   设置超时时间</span></span><br><span class="line"><span class="code">            *      1). 默认值是-1, 表示永不超时</span></span><br><span class="line"><span class="code">            *      2). 单位是秒</span></span><br><span class="line"><span class="code">            * */</span></span><br><span class="line"><span class="code">        td.setTimeout(10);</span></span><br><span class="line"><span class="code">            /*</span></span><br><span class="line"><span class="code">                设置事务传播行为</span></span><br><span class="line"><span class="code">                    1. 一般增删改：REQUIRED (默认值)</span></span><br><span class="line"><span class="code">                    2. 一般查询  SUPPORTS</span></span><br><span class="line"><span class="code">                    这个比较复杂,待会详解</span></span><br><span class="line"><span class="code">            * */</span></span><br><span class="line"><span class="code">        td.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span></span><br></pre></td></tr></table></figure>

<h4 id="III-TransactionStatus接口-了解"><a href="#III-TransactionStatus接口-了解" class="headerlink" title="III. TransactionStatus接口(了解)"></a><strong>III. TransactionStatus接口</strong>(了解)</h4><p>此接口定义了事务在执行过程中某个时间点上的状态信息及对应的状态操作</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1610129473364.png"
                      alt="1610129473364"
                > </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    <span class="doctag">TODO:</span> 声明式事务</span></span><br><span class="line"><span class="comment">    1. 底层: 封装了事务切面类 TxAdvice</span></span><br><span class="line"><span class="comment">        因为TxAdvice的编写是固定的,所以可以封装</span></span><br><span class="line"><span class="comment">        1). 事务管理器不是固定的 (因为跟dao层框架有关系)</span></span><br><span class="line"><span class="comment">        2). 事务属性不是固定的 (不同的业务方法,可能需要不同事务属性)</span></span><br><span class="line"><span class="comment">        3). 切入点不是固定的</span></span><br><span class="line"><span class="comment">    2. 使用  : 声明即可用</span></span><br><span class="line"><span class="comment">        1). 在配置类上加</span></span><br><span class="line"><span class="comment">            //<span class="doctag">TODO:</span> 开启事务管理支持 (声明式事务的第一步)</span></span><br><span class="line"><span class="comment">                @EnableTransactionManagement</span></span><br><span class="line"><span class="comment">        2). 在配置类里加</span></span><br><span class="line"><span class="comment">              //<span class="doctag">TODO:</span> 配置事务管理器 (声明式事务的第二步)</span></span><br><span class="line"><span class="comment">                @Bean</span></span><br><span class="line"><span class="comment">                public DataSourceTransactionManager getTxManager(DataSource dataSource)&#123;</span></span><br><span class="line"><span class="comment">                    DataSourceTransactionManager manager = new DataSourceTransactionManager();</span></span><br><span class="line"><span class="comment">                    manager.setDataSource(dataSource);</span></span><br><span class="line"><span class="comment">                    return manager;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">       3). @Transactional 注解</span></span><br><span class="line"><span class="comment">            I. 可以直接放在接口上 , 表示该接口的所有方法都是切入点  (推荐)</span></span><br><span class="line"><span class="comment">            II. 可以放在接口方法上, 表示该方法的所有重写方法切入点 (推荐)</span></span><br><span class="line"><span class="comment">            III. 放在实现类上,表示该实现类所有方法都是切入点</span></span><br><span class="line"><span class="comment">            IV. 放在实现类的方法上,表示该方法是切入点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> 配置需要事务支持的切入点 (声明式事务的第三步)</span></span><br><span class="line">    <span class="meta">@Transactional(</span></span><br><span class="line"><span class="meta">            isolation = Isolation.DEFAULT,</span></span><br><span class="line"><span class="meta">            readOnly = false,</span></span><br><span class="line"><span class="meta">            timeout = -1,</span></span><br><span class="line"><span class="meta">            propagation = Propagation.REQUIRED</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId,<span class="type">int</span> inId,<span class="type">double</span> money)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-3-事务传播行为"><a href="#4-4-3-事务传播行为" class="headerlink" title="4.4.3)事务传播行为"></a>4.4.3)事务传播行为</h3><p><strong>事务传播行为</strong>：指的就是当一个事务方法A被另一个事务方法B调用时，这个事务方法A应该对待B的事务态度。</p>
<p>以下将涉及两个概念:</p>
<p><strong>1. 事务管理员:</strong> 比如service层的transfer方法</p>
<p><strong>2. 事务协调员</strong>: 比如dao层的两个方法</p>
<p>事务协调员对待管理员所携带事务的处理态度</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1610126554727.png"
                      alt="1610126554727"
                > </p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/gangan0623/note/main/img/1610126339601.png"
                      alt="1610126339601"
                > </p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 运用场景举例</span></span><br><span class="line"><span class="bullet">1.</span> 还是以转账操作为例 : S(事务管理员)</span><br><span class="line"><span class="bullet">    -</span> 子业务S1：X用户执行转出操作,修改表 , Y用户执行转入操作,修改表 (事务协调员S1)</span><br><span class="line"><span class="bullet">    -</span> 子业务S2：银行记录转账日志到数据库日志表中 (事务协调员S2)</span><br><span class="line"><span class="bullet">2.</span> 理解:</span><br><span class="line"><span class="code">	1). 如果转账S操作失败了, S1需要回滚(S1的事务肯定需要事务)</span></span><br><span class="line"><span class="code">		如果S有事务,S1跟随即可, 如果S没有事务,S1需要自己创建事务</span></span><br><span class="line"><span class="code">		所以S1适合设置传播行为属性为REQUIRED</span></span><br><span class="line"><span class="code">	2). 如果转账S操作失败了, S2不需要回滚,必须要执行</span></span><br><span class="line"><span class="code">    	如果S有事务,S2不跟随, </span></span><br><span class="line"><span class="code">    	如果S没有事务,S2可以有也可以没有事务</span></span><br><span class="line"><span class="code">    	如果S2需要事务,那么S2设置为requires_new</span></span><br><span class="line"><span class="code">    	如果S2不需要事务,那么S2设置为not_supported</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"></span><br><span class="line"><span class="section"># 使用规范</span></span><br><span class="line"><span class="bullet">1.</span> 一般增删改：加事务 REQUIRED  (默认取值)</span><br><span class="line"><span class="bullet">2.</span> 一般查询：不加事务 SUPPORTS</span><br><span class="line"><span class="bullet">3.</span> 非主要业务不对主业务造成影响：REQUIRES<span class="emphasis">_NEW</span></span><br><span class="line"><span class="emphasis">4. 必须在有事务的环境运行：MANDATORY</span></span><br><span class="line"><span class="emphasis"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 代码编写注意</span></span><br><span class="line"><span class="bullet">1.</span> 事务传播行为是发生在两个bean之间的</span><br><span class="line"><span class="bullet">2.</span> S操作 (事务管理员) 单独一个Bean</span><br><span class="line"><span class="bullet">3.</span> S1和S2操作 (事务协调员)单独封装到一个Bean中</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    S操作 (事务管理员) 单独一个Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountServiceClass asc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="comment">//如果切入点有异常,不能catch</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> outId, <span class="type">int</span> inId, <span class="type">double</span> money)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">            asc.s1(outId, inId, money);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            asc.s2();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    S1和S2操作 (事务协调员)单独封装到一个Bean中</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    事务传播行为: 事务协调员对事务管理员所持事务的态度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceClass</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao dao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(</span></span><br><span class="line"><span class="meta">            propagation = Propagation.REQUIRED</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="comment">//如果切入点有异常,不能catch</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">S1</span><span class="params">(<span class="type">int</span> outId, <span class="type">int</span> inId, <span class="type">double</span> money)</span> &#123;</span><br><span class="line">            dao.outMoney(outId, money);</span><br><span class="line">            <span class="comment">//可能在转账过程中发生意外: 转出执行,转入还未执行</span></span><br><span class="line">            dao.inMoney(inId, money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        create table db_log(</span></span><br><span class="line"><span class="comment">            id int primary key auto_increment,</span></span><br><span class="line"><span class="comment">            message varchar(20)</span></span><br><span class="line"><span class="comment">        );</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    insert into db_log values(null,&quot;测试&quot;);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(</span></span><br><span class="line"><span class="meta">            propagation = Propagation.REQUIRES_NEW</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">S2</span><span class="params">()</span> &#123;</span><br><span class="line">        dao.insertLog(<span class="string">&quot;转账日志&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>

        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/04/18/01_Spring%E5%85%A5%E9%97%A8/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Spring入门</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/04/18/03_SpringMVC/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">SpringMVC</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">TaoHongqiang</a>
        </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="nav-text">1.  动态代理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E2%80%94%E2%80%94JDK-Proxy"><span class="nav-text">1.1) 动态代理——JDK Proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E2%80%94%E2%80%94CGLIB"><span class="nav-text">1.2) 动态代理——CGLIB</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Spring-AOP"><span class="nav-text">2. Spring-AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-AOP%E6%A6%82%E8%BF%B0"><span class="nav-text">2.1) AOP概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-AOP%E5%85%A5%E9%97%A8"><span class="nav-text">2.2) AOP入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-AOP%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-text">2.2.1) AOP相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-AOP%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="nav-text">2.2.2 )AOP开发过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-AOP%E5%BC%80%E5%8F%91%E6%96%B9%E5%BC%8F"><span class="nav-text">2.2.3 )AOP开发方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-AOP%E9%85%8D%E7%BD%AE-%E9%87%8D%E7%82%B9"><span class="nav-text">2.3 )AOP配置 (重点)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">2.3.1) 入门案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A41"><span class="nav-text">步骤1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42"><span class="nav-text">步骤2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A43"><span class="nav-text">步骤3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A44"><span class="nav-text">步骤4</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E6%A1%88%E4%BE%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">2.3.2) 案例详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-1-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">2.3.2.1) 案例分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-2-%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">2.3.2.2) 切入点表达式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-3-%E9%80%9A%E7%9F%A5%E7%B1%BB%E5%9E%8B"><span class="nav-text">2.3.2.3) 通知类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-AOP%E5%B0%8F%E7%BB%83%E4%B9%A0"><span class="nav-text">2.4) AOP小练习</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E4%BA%8B%E5%8A%A1"><span class="nav-text">3. 事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E4%BA%8B%E5%8A%A1%E5%9B%9E%E9%A1%BE"><span class="nav-text">3.1) 事务回顾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E4%BA%8B%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="nav-text">3.1.1)事务介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-text">3.1.2)事务的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">3.1.3)事务的隔离级别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E8%BD%AC%E8%B4%A6%E6%A1%88%E4%BE%8B"><span class="nav-text">3.2). 转账案例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Spring%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">4. Spring声明式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E4%BA%86%E8%A7%A3"><span class="nav-text">4.1 编程式事务(了解)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-AOP%E6%94%B9%E9%80%A0%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E4%BA%86%E8%A7%A3"><span class="nav-text">4.2 AOP改造编程式事务(了解)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E9%87%8D%E7%82%B9"><span class="nav-text">4.3 声明式事务(  重点)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-Spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-text">4.4 Spring事务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-Spring%E4%BA%8B%E5%8A%A1%E6%A0%B8%E5%BF%83%E5%AF%B9%E8%B1%A1"><span class="nav-text">4.4.1)Spring事务核心对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-Spring%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3API"><span class="nav-text">4.4.2)Spring事务相关API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#I-PlatformTransactionManager"><span class="nav-text">I. PlatformTransactionManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#II-TransactionDefinition%E6%8E%A5%E5%8F%A3"><span class="nav-text">II. TransactionDefinition接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#III-TransactionStatus%E6%8E%A5%E5%8F%A3-%E4%BA%86%E8%A7%A3"><span class="nav-text">III. TransactionStatus接口(了解)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="nav-text">4.4.3)事务传播行为</span></a></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
